# java问题排查

## 1 思路

### 1.1 查看系统环境信息

获取目前内存、cpu占用情况

```sh
top
```

获取占用CPU资源最多的10个进程

```sh
ps aux|head -1;ps aux|sort -rn -k +3|head
```

获取占用内存资源最多的10个进程

```sh
ps aux|head -1;ps aux|sort -rn -k +4|head
```

### 1.2 查看堆栈信息

在故障定位的时候，常常要查看两种堆栈：

* heap dump：记录内存信息，使用`jmap`命令生成

```sh
jmap -dump:live,format=b,file=heap.hprof <pid>
```

* thread dump：记录CPU信息，使用`jstack`命令查看

```sh
jstack <pid>
```

### 1.3 MAT使用

生成heap dump之后，可以使用Eclipse Memory Analyzer（简称MAT）来辅助发现内存泄漏减少内存占用，MAT是一个功能丰富且操作简单的JVM Heap Dump分析工具，使用 Memory Analyzer 来分析生产环境的 Java 堆转储文件，可以从数以百万计的对象中快速计算出对象的 Retained Size，查看是谁在阻止垃圾回收，并自动生成一个 Leak Suspect（内存泄露可疑点）报表。

## 2 常用工具

### 2.1 jps

jps是jdk提供的一个查看当前java进程的小工具， 可以看做是JavaVirtual Machine Process Status Tool的缩写。

常用命令：

```sh
jps # 显示进程的ID 和 类的名称
jps –l # 输出输出完全的包名，应用主类名，jar的完全路径名 
jps –v # 输出jvm参数
jps –q # 显示java进程号
jps -m # main 方法
jps -l xxx.xxx.xx.xx # 远程查看 
```

### 2.2 jstat

查看jvm情况，常用用法

```sh
jstat -gcutil <pid> 1000 
```

输出样例

```sh
S0     S1     E      O      M     CCS    YGC     YGCT    FGC    FGCT     GCT   
0.00  98.28  37.11   5.26  95.30  92.71     15    0.346     3    0.221    0.567
0.00  98.28  37.11   5.26  95.30  92.71     15    0.346     3    0.221    0.567
0.00  98.28  37.11   5.26  95.30  92.71     15    0.346     3    0.221    0.567
0.00  98.28  37.11   5.26  95.30  92.71     15    0.346     3    0.221    0.567
0.00  98.28  37.11   5.26  95.30  92.71     15    0.346     3    0.221    0.567
0.00  98.28  37.11   5.26  95.30  92.71     15    0.346     3    0.221    0.567
0.00  98.28  37.11   5.26  95.30  92.71     15    0.346     3    0.221    0.567
0.00  98.28  37.11   5.26  95.30  92.71     15    0.346     3    0.221    0.567
0.00  98.28  37.11   5.26  95.30  92.71     15    0.346     3    0.221    0.567
0.00  98.28  37.11   5.26  95.30  92.71     15    0.346     3    0.221    0.567
0.00  98.28  37.11   5.26  95.30  92.71     15    0.346     3    0.221    0.567
0.00  98.28  37.11   5.26  95.30  92.71     15    0.346     3    0.221    0.567
0.00  98.28  37.11   5.26  95.30  92.71     15    0.346     3    0.221    0.567
```

字段解释

| 列名 |                           描述                           |
| :--: | :------------------------------------------------------: |
|  S0  | 年轻代中第一个survivor（幸存区）已使用的占当前容量百分比 |
|  S1  | 年轻代中第二个survivor（幸存区）已使用的占当前容量百分比 |
|  E   |      年轻代中Eden（伊甸园）已使用的占当前容量百分比      |
|  O   |              old代已使用的占当前容量百分比               |
|  M   |                     元数据区使用比例                     |
| CCS  |                       压缩使用比例                       |
| YGC  |           从应用程序启动到采样时年轻代中gc次数           |
| YGCT |       从应用程序启动到采样时年轻代中gc所用时间(s)        |
| FGC  |         从应用程序启动到采样时老年代full gc次数          |
| FGCT |      从应用程序启动到采样时老年代full gc所用时间(s)      |
| GCT  |          从应用程序启动到采样时gc用的总时间(s)           |